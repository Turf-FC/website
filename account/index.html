<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sports Competition Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --primary: #37238d;
        --success: #6eb553;
        --error: #c63035;
        --warning: #eee248;
        --black: #000000;
        --white: #ffffff;
        --gray-100: #f5f5f5;
        --gray-200: #e5e5e5;
        --gray-300: #d4d4d4;
        --gray-400: #a3a3a3;
        --gray-500: #737373;
        --gray-600: #525252;
        --gray-700: #404040;
        --gray-800: #262626;
        --gray-900: #171717;

        --bg-primary: var(--white);
        --bg-secondary: var(--gray-100);
        --text-primary: var(--gray-900);
        --text-secondary: var(--gray-700);
        --border-color: var(--gray-300);
      }

      [data-theme="dark"] {
        --bg-primary: var(--gray-900);
        --bg-secondary: var(--gray-800);
        --text-primary: var(--gray-100);
        --text-secondary: var(--gray-300);
        --border-color: var(--gray-700);
      }

      * {
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }

      body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
      }

      .bg-primary {
        background-color: var(--bg-primary);
      }
      .bg-secondary {
        background-color: var(--bg-secondary);
      }
      .text-primary {
        color: var(--text-primary);
      }
      .text-secondary {
        color: var(--text-secondary);
      }
      .border-custom {
        border-color: var(--border-color);
      }

      .btn-primary {
        background-color: var(--primary);
        color: var(--white);
      }

      .btn-success {
        background-color: var(--success);
        color: var(--white);
      }

      .btn-error {
        background-color: var(--error);
        color: var(--white);
      }

      .sidebar-item:hover {
        background-color: var(--bg-secondary);
      }

      .sidebar-item.active {
        background-color: var(--primary);
        color: var(--white);
      }

      .bottom-nav-item {
        transition: all 0.2s ease;
      }

      .bottom-nav-item.active {
        background-color: var(--primary);
        color: var(--white);
        border-radius: 8px;
      }

      .bottom-nav-item.active svg {
        transform: scale(1.1);
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background-color: var(--bg-secondary);
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: var(--text-secondary);
      }

      .toast {
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .loading-spinner {
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .multi-select-dropdown {
        max-height: 200px;
        overflow-y: auto;
      }

      input,
      select,
      textarea {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border-color: var(--border-color);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(55, 35, 141, 0.1);
      }

      .archived-item {
        opacity: 0.6;
      }

      .detail-panel {
        background-color: var(--bg-secondary);
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1rem;
      }

      .detail-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background-color: var(--bg-primary);
        border-radius: 6px;
        margin-bottom: 0.5rem;
        border: 1px solid var(--border-color);
      }

      .player-image {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        background-color: var(--bg-secondary);
      }

      .file-upload-label {
        display: inline-block;
        padding: 0.5rem 1rem;
        background-color: var(--primary);
        color: white;
        border-radius: 6px;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .file-upload-label:hover {
        opacity: 0.9;
      }

      .image-preview {
        width: 100px;
        height: 100px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid var(--border-color);
      }

      .mobile-form-overlay {
        transition: transform 0.3s ease-in-out;
      }

      @media (max-width: 768px) {
        .mobile-form-overlay.hidden-mobile {
          transform: translateY(100%);
        }
      }

      .event-description-helper {
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-style: italic;
        margin-top: 0.25rem;
      }

      .participant-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-bottom: 0.5rem;
      }

      .participant-number {
        background-color: var(--primary);
        color: var(--white);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
        margin-right: 0.75rem;
      }
    </style>
  </head>
  <body class="font-sans antialiased">
    <!-- Login Page -->
    <div id="loginPage" class="hidden min-h-screen flex items-center justify-center bg-primary px-4">
      <div class="bg-secondary p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md">
        <div class="text-center mb-6 md:mb-8">
          <div class="w-16 h-16 md:w-20 md:h-20 bg-primary rounded-full mx-auto flex items-center justify-center text-white text-xl md:text-2xl font-bold">SC</div>
          <h1 class="text-xl md:text-2xl font-bold mt-4 text-primary">Sports Competition Admin</h1>
          <p class="text-secondary mt-2 text-sm md:text-base">Sign in to manage your competitions</p>
        </div>
        <form id="loginForm">
          <div class="mb-4">
            <label class="block text-secondary text-sm font-medium mb-2">Username</label>
            <input type="text" id="loginUsername" class="w-full px-4 py-2 rounded-md border border-custom focus:ring-2" required />
          </div>
          <div class="mb-6">
            <label class="block text-secondary text-sm font-medium mb-2">Password</label>
            <input type="password" id="loginPassword" class="w-full px-4 py-2 rounded-md border border-custom focus:ring-2" required />
          </div>
          <div id="loginError" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
          <button type="submit" class="w-full btn-primary py-2 px-4 rounded-md font-medium hover:opacity-90">Sign In</button>
        </form>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
      <!-- Desktop Sidebar -->
      <div class="hidden md:block w-64 bg-secondary border-r border-custom">
        <div class="p-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white text-sm font-bold">SC</div>
            <span class="text-xl font-bold text-primary">Sports Admin</span>
          </div>
        </div>

        <nav class="mt-8">
          <a href="#" data-entity="competitions" class="sidebar-item block px-4 py-3 text-primary cursor-pointer">
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              <span>Competitions</span>
            </div>
          </a>
          <a href="#" data-entity="teams" class="sidebar-item block px-4 py-3 text-primary cursor-pointer">
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <span>Teams</span>
            </div>
          </a>
          <a href="#" data-entity="players" class="sidebar-item block px-4 py-3 text-primary cursor-pointer">
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <span>Players</span>
            </div>
          </a>
          <a href="#" data-entity="fixtures" class="sidebar-item block px-4 py-3 text-primary cursor-pointer">
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span>Fixtures</span>
            </div>
          </a>
          <a href="#" data-entity="events" class="sidebar-item block px-4 py-3 text-primary cursor-pointer">
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              <span>Events</span>
            </div>
          </a>
        </nav>

        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-custom">
          <label class="flex items-center space-x-2 text-sm text-secondary cursor-pointer mb-3">
            <input type="checkbox" id="showArchived" class="rounded" />
            <span>Show archived items</span>
          </label>
          <button id="logoutBtn" class="w-fit btn-error py-2 px-4 rounded-md text-sm font-medium hover:opacity-90">Logout</button>
        </div>
      </div>

      <!-- Mobile Bottom Navigation -->
      <div class="fixed bottom-0 left-0 right-0 bg-secondary border-t border-custom z-40 md:hidden">
        <nav class="flex justify-around items-center h-16">
          <a href="#" data-entity="competitions" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-xs cursor-pointer py-2">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            <span>Competitions</span>
          </a>
          <a href="#" data-entity="teams" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-xs cursor-pointer py-2">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span>Teams</span>
          </a>
          <a href="#" data-entity="players" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-xs cursor-pointer py-2">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span>Players</span>
          </a>
          <a href="#" data-entity="fixtures" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-xs cursor-pointer py-2">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>Fixtures</span>
          </a>
          <a href="#" data-entity="events" class="bottom-nav-item flex-1 flex flex-col items-center justify-center text-xs cursor-pointer py-2">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span>Events</span>
          </a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col mb-16 md:mb-0">
        <!-- Header -->
        <header class="bg-secondary border-b border-custom px-4 md:px-6 py-3 md:py-4">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <h1 id="entityTitle" class="text-lg md:text-2xl font-bold text-primary truncate">Competitions</h1>
              <p id="entityDescription" class="text-secondary mt-1 text-xs md:text-sm truncate">Manage your sports competitions</p>
            </div>
            <div class="flex items-center space-x-2 md:space-x-4">
              <button id="addNewBtn" class="md:hidden btn-primary p-2 rounded-md hover:opacity-90">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
              </button>
              <span id="connectionStatus" class="hidden md:inline-block px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">Connected</span>
              <button id="refreshBtn" class="p-2 rounded-md hover:bg-primary hover:bg-opacity-10">
                <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </button>
              <button id="themeToggle" class="p-2 rounded-md hover:bg-primary hover:bg-opacity-10">
                <svg id="sunIcon" class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moonIcon" class="hidden w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
              </button>
              <button id="mobileMenuBtn" class="md:hidden p-2 rounded-md hover:bg-primary hover:bg-opacity-10">
                <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
              </button>
            </div>
          </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
          <!-- List Panel -->
          <div class="flex-1 md:w-3/5 bg-primary border-r border-custom overflow-y-auto custom-scrollbar">
            <div class="p-3 md:p-4 border-b border-custom">
              <input type="text" id="searchInput" placeholder="Search..." class="w-full px-3 md:px-4 py-2 rounded-md border border-custom text-sm md:text-base" />
            </div>
            <div id="listContent" class="p-3 md:p-4">
              <div class="text-center py-8 text-secondary">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-4 text-sm md:text-base">Loading...</p>
              </div>
            </div>
          </div>

          <!-- Desktop Form Panel -->
          <div class="hidden md:block w-2/5 bg-secondary p-6 overflow-y-auto custom-scrollbar">
            <h2 class="text-xl font-bold text-primary mb-4">Add New Item</h2>
            <form id="entityForm">
              <div id="formFields"></div>
              <div class="flex space-x-3 mt-6">
                <button type="submit" class="flex-1 btn-success py-2 px-4 rounded-md font-medium hover:opacity-90">Save</button>
                <button type="reset" class="flex-1 bg-secondary border border-custom text-primary py-2 px-4 rounded-md font-medium hover:opacity-90">Reset</button>
              </div>
            </form>
          </div>

          <!-- Mobile Form Overlay -->
          <div id="mobileFormOverlay" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-30 hidden">
            <div class="mobile-form-overlay absolute bottom-0 left-0 right-0 bg-secondary rounded-t-3xl max-h-[85vh] overflow-hidden flex flex-col pb-20">
              <div class="p-4 border-b border-custom flex items-center justify-between">
                <h2 class="text-lg font-bold text-primary">Add New Item</h2>
                <button id="closeMobileForm" class="p-2 hover:bg-primary hover:bg-opacity-10 rounded-md">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
                <form id="mobileEntityForm">
                  <div id="mobileFormFields"></div>
                  <div class="flex space-x-3 mt-6 mb-4">
                    <button type="submit" class="flex-1 btn-success py-3 px-4 rounded-md font-medium hover:opacity-90">Save</button>
                    <button type="reset" class="flex-1 bg-secondary border border-custom text-primary py-3 px-4 rounded-md font-medium hover:opacity-90">Reset</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenuOverlay" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
      <div class="absolute right-0 top-0 bottom-0 w-64 bg-secondary">
        <div class="p-4 border-b border-custom flex items-center justify-between">
          <span class="text-lg font-bold text-primary">Menu</span>
          <button id="closeMobileMenu" class="p-2 hover:bg-primary hover:bg-opacity-10 rounded-md">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-4">
          <label class="flex items-center space-x-2 text-sm text-secondary cursor-pointer mb-4">
            <input type="checkbox" id="showArchivedMobile" class="rounded" />
            <span>Show archived items</span>
          </label>
          <button id="logoutBtnMobile" class="w-full btn-error py-2 px-4 rounded-md text-sm font-medium hover:opacity-90">Logout</button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50"></div>

    <!-- Confirmation Dialog -->
    <div id="confirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
      <div class="bg-secondary p-6 rounded-lg max-w-md w-full">
        <h3 class="text-xl font-bold text-primary mb-3">Confirm Action</h3>
        <p id="confirmMessage" class="text-secondary mb-6">Are you sure you want to perform this action?</p>
        <div class="flex space-x-3">
          <button id="confirmYes" class="flex-1 btn-error py-2 px-4 rounded-md font-medium hover:opacity-90">Yes, Continue</button>
          <button id="confirmNo" class="flex-1 bg-secondary border border-custom text-primary py-2 px-4 rounded-md font-medium hover:opacity-90">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const API_BASE_URL = "https://api.turffc.club"
      let authToken = localStorage.getItem("authToken")
      let currentEntity = "competitions"
      let currentEditId = null
      let entityData = []
      let teamsData = []
      let playersData = []
      let fixturesData = []
      let eventsData = []
      let competitionsData = []
      let selectedCompetitionTeams = []
      let selectedTeamPlayers = []
      let currentSelectedItem = null
      let orderedParticipants = []

      // Football positions
      const footballPositions = ["GK", "CB", "RCB", "LCB", "RB", "LB", "RWB", "LWB", "CDM", "CM", "LCM", "RCM", "CAM", "LM", "RM", "LAM", "RAM", "CF", "ST"]

      // Competition formats
      const competitionFormats = ["Round Robin: Single Legs", "Round Robin: Double Legs", "Knockout: Finals", "Knockout: With Group Stage"]

      // Event types
      const eventTypes = [
        {
          title: "Kick Off",
          description: "Fixture is underway",
        },
        {
          title: "Half Time",
          description: "Fixture is at half time",
        },
        {
          title: "Full Time",
          description: "Fixture has ended",
        },
        {
          title: "Yellow Card",
          description: "Player has received a yellow card",
        },
        {
          title: "Red Card",
          description: "Player has received a red card",
        },
        {
          title: "Substitution",
          description: "Player substitution has been made",
        },
        {
          title: "Injury Time",
          description: "Injury time has been added",
        },
        {
          title: "Penalty",
          description: "A penalty has been awarded",
        },
        {
          title: "Goal",
          description: "A goal has been scored",
        },
        {
          title: "Own Goal",
          description: "An own goal has been scored",
        },
      ]

      // Entity configurations
      const entityConfigs = {
        competitions: {
          title: "Competitions",
          description: "Manage your sports competitions",
          fields: [
            { name: "year", label: "Year", type: "number", required: true },
            { name: "starts", label: "Start Date", type: "datetime-local", required: true },
            { name: "format", label: "Format", type: "select", required: true, options: competitionFormats },
            { name: "teams", label: "Teams", type: "multi-select-teams", required: false },
          ],
          columns: ["ID", "Year", "Start Date", "Format"],
          hasDetails: true,
        },

        teams: {
          title: "Teams",
          description: "Manage participating teams",
          fields: [
            { name: "letter", label: "Team Letter", type: "text", required: true },
            { name: "alias", label: "Team Name", type: "text", required: true },
            { name: "color", label: "Team Color", type: "color", required: true, default: "#3B82F6" },
          ],
          columns: ["ID", "Letter", "Name", "Color"],
          hasDetails: true,
        },

        players: {
          title: "Players",
          description: "Manage player profiles",
          fields: [
            { name: "firstName", label: "First Name", type: "text", required: true },
            { name: "lastName", label: "Last Name", type: "text", required: true },
            { name: "alias", label: "Alias/Nickname", type: "text", required: false },
            { name: "team", label: "Team", type: "select-teams", required: true },
            { name: "primaryPosition", label: "Primary Position", type: "select", required: true, options: footballPositions },
            { name: "alternatePositions", label: "Alternate Positions", type: "multi-select", required: false, options: footballPositions, max: 4 },
            { name: "image", label: "Player Image", type: "file", required: false, accept: "image/*" },
          ],
          columns: ["ID", "First Name", "Last Name", "Team", "Primary Position"],
        },

        fixtures: {
          title: "Fixtures",
          description: "Manage match fixtures",
          fields: [
            { name: "competition", label: "Competition", type: "select-competitions", required: true },
            { name: "homeTeam", label: "Home Team", type: "select-teams", required: true },
            { name: "awayTeam", label: "Away Team", type: "select-teams", required: true },
            { name: "starts", label: "Kick-off Time", type: "datetime-local", required: true },
            { name: "referee", label: "Referee", type: "text", required: false },
            // { name: "hasHalves", label: "Has Halves?", type: "checkbox", required: false },
            { name: "venue", label: "Venue", type: "text", required: false, default: "Mo Arena" },
            { name: "finalScore", label: "Final Score", type: "text", required: false, placeholder: "2-1" },
            // { name: "events", label: "Events", type: "multi-select-events", required: false },
          ],
          columns: ["ID", "Kick-off Time", "Venue", "Referee", "Final Score"],
        },

        events: {
          title: "Events",
          description: "Manage match events",
          fields: [
            { name: "fixture", label: "Fixture", type: "select-fixtures", required: true },
            { name: "title", label: "Event Type", type: "select-events", required: true },
            { name: "notes", label: "Notes", type: "textarea", required: false },
            { name: "participants", label: "Participants", type: "ordered-select-players", required: false },
          ],
          columns: ["ID", "Type", "Notes", "Participants"],
        },
      }

      // Theme Management
      function initTheme() {
        const savedTheme = localStorage.getItem("theme") || "light"
        document.documentElement.setAttribute("data-theme", savedTheme)
        updateThemeIcon(savedTheme)
      }

      function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute("data-theme")
        const newTheme = currentTheme === "light" ? "dark" : "light"
        document.documentElement.setAttribute("data-theme", newTheme)
        localStorage.setItem("theme", newTheme)
        updateThemeIcon(newTheme)
      }

      function updateThemeIcon(theme) {
        const sunIcon = document.getElementById("sunIcon")
        const moonIcon = document.getElementById("moonIcon")
        if (theme === "light") {
          sunIcon.classList.remove("hidden")
          moonIcon.classList.add("hidden")
        } else {
          sunIcon.classList.add("hidden")
          moonIcon.classList.remove("hidden")
        }
      }

      // Toast Notifications
      function showToast(message, type = "success") {
        const toastContainer = document.getElementById("toastContainer")
        const toast = document.createElement("div")
        const bgColor = type === "success" ? "bg-green-500" : type === "error" ? "bg-red-500" : "bg-yellow-500"

        toast.className = `toast ${bgColor} text-white p-3 md:p-4 rounded-lg shadow-lg mb-3 min-w-[200px] md:min-w-[250px] text-sm md:text-base`
        toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${type === "success" ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'}
                    </svg>
                    <span>${message}</span>
                </div>
            `

        toastContainer.appendChild(toast)
        setTimeout(() => {
          toast.remove()
        }, 3000)
      }

      // Confirmation Dialog
      function showConfirmDialog(message) {
        return new Promise((resolve) => {
          const dialog = document.getElementById("confirmDialog")
          const messageEl = document.getElementById("confirmMessage")
          const yesBtn = document.getElementById("confirmYes")
          const noBtn = document.getElementById("confirmNo")

          messageEl.textContent = message
          dialog.classList.remove("hidden")

          const handleYes = () => {
            dialog.classList.add("hidden")
            yesBtn.removeEventListener("click", handleYes)
            noBtn.removeEventListener("click", handleNo)
            resolve(true)
          }

          const handleNo = () => {
            dialog.classList.add("hidden")
            yesBtn.removeEventListener("click", handleYes)
            noBtn.removeEventListener("click", handleNo)
            resolve(false)
          }

          yesBtn.addEventListener("click", handleYes)
          noBtn.addEventListener("click", handleNo)
        })
      }

      // Mobile Menu
      function showMobileMenu() {
        document.getElementById("mobileMenuOverlay").classList.remove("hidden")
      }

      function hideMobileMenu() {
        document.getElementById("mobileMenuOverlay").classList.add("hidden")
      }

      // Mobile Form
      function showMobileForm() {
        document.getElementById("mobileFormOverlay").classList.remove("hidden")
      }

      function hideMobileForm() {
        document.getElementById("mobileFormOverlay").classList.add("hidden")
      }

      // API Functions
      async function makeRequest(url, options = {}) {
        try {
          const headers = {
            "Content-Type": "application/json",
            ...options.headers,
          }

          if (authToken) {
            headers["Authorization"] = `Bearer ${authToken}`
          }

          const response = await fetch(`${API_BASE_URL}${url}`, {
            ...options,
            headers,
          })

          if (response.status === 401) {
            localStorage.removeItem("authToken")
            showLoginPage()
            throw new Error("Authentication required")
          }

          if (!response.ok) {
            throw new Error(`Request failed: ${response.status}`)
          }

          return await response.json()
        } catch (error) {
          console.error("API request failed:", error)
          throw error
        }
      }

      // Authentication
      async function login(username, password) {
        try {
          const data = await makeRequest("/auth/login", {
            method: "POST",
            body: JSON.stringify({ username, password }),
          })

          authToken = data.token
          localStorage.setItem("authToken", authToken)
          showDashboard()
          showToast("Login successful!")
        } catch (error) {
          document.getElementById("loginError").textContent = "Invalid credentials"
          document.getElementById("loginError").classList.remove("hidden")
        }
      }

      async function checkAuth() {
        if (!authToken) {
          showLoginPage()
          return
        }

        try {
          await makeRequest("/auth/check")
          showDashboard()
        } catch (error) {
          showLoginPage()
        }
      }

      function logout() {
        localStorage.removeItem("authToken")
        authToken = null
        showLoginPage()
        showToast("Logged out successfully")
        hideMobileMenu()
      }

      // Page Navigation
      function showLoginPage() {
        document.getElementById("loginPage").classList.remove("hidden")
        document.getElementById("dashboard").classList.add("hidden")
      }

      function showDashboard() {
        document.getElementById("loginPage").classList.add("hidden")
        document.getElementById("dashboard").classList.remove("hidden")
        loadAllRelatedData()
        loadEntity(currentEntity)
      }

      // Entity Management
      async function loadAllRelatedData() {
        await loadTeams()
        await loadPlayers()
        await loadFixtures()
        await loadEvents()
        await loadCompetitions()
      }

      async function loadEntity(entity) {
        currentEntity = entity
        currentEditId = null
        currentSelectedItem = null
        orderedParticipants = []

        // Update sidebar active state (desktop)
        document.querySelectorAll(".sidebar-item").forEach((item) => {
          if (item.dataset.entity === entity) {
            item.classList.add("active")
          } else {
            item.classList.remove("active")
          }
        })

        // Update bottom nav active state (mobile)
        document.querySelectorAll(".bottom-nav-item").forEach((item) => {
          if (item.dataset.entity === entity) {
            item.classList.add("active")
          } else {
            item.classList.remove("active")
          }
        })

        // Update header
        const config = entityConfigs[entity]
        document.getElementById("entityTitle").textContent = config.title
        document.getElementById("entityDescription").textContent = config.description

        // Load data
        try {
          const showArchived = document.getElementById("showArchived").checked
          const url = `/${entity}${showArchived ? "?includeArchived=true" : ""}`
          entityData = await makeRequest(url)
          renderList()
          renderForm()
        } catch (error) {
          showToast("Failed to load data", "error")
          entityData = []
          renderList()
          renderForm()
        }
      }

      async function loadTeams() {
        try {
          teamsData = await makeRequest("/teams")
        } catch (error) {
          teamsData = []
        }
      }

      async function loadPlayers() {
        try {
          playersData = await makeRequest("/players")
        } catch (error) {
          playersData = []
        }
      }

      async function loadFixtures() {
        try {
          fixturesData = await makeRequest("/fixtures")
        } catch (error) {
          fixturesData = []
        }
      }

      async function loadEvents() {
        try {
          eventsData = await makeRequest("/events")
        } catch (error) {
          eventsData = []
        }
      }

      async function loadCompetitions() {
        try {
          competitionsData = await makeRequest("/competitions")
        } catch (error) {
          competitionsData = []
        }
      }

      // List Rendering
      function renderList() {
        const listContent = document.getElementById("listContent")
        const searchTerm = document.getElementById("searchInput").value.toLowerCase()
        const config = entityConfigs[currentEntity]

        const filteredData = entityData.filter((item) => {
          const searchString = Object.values(item).join(" ").toLowerCase()
          return searchString.includes(searchTerm)
        })

        if (filteredData.length === 0) {
          listContent.innerHTML = `
                    <div class="text-center py-8 text-secondary">
                        <svg class="w-10 h-10 md:w-12 md:h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                        </svg>
                        <p class="text-sm md:text-base">No items found</p>
                    </div>
                `
          return
        }

        let html = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm md:text-base">
                        <thead>
                            <tr class="border-b border-custom">
                                ${config.columns.map((col) => `<th class="text-left py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm font-medium text-secondary">${col}</th>`).join("")}
                                <th class="text-left py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm font-medium text-secondary">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `

        filteredData.forEach((item) => {
          const isArchived = item.archived || false
          const itemId = item.id || item._id
          const clickHandler = config.hasDetails ? `onclick="showItemDetails('${itemId}')"` : ""
          const cursorClass = config.hasDetails ? "cursor-pointer" : ""

          html += `<tr class="border-b border-custom hover:bg-secondary ${isArchived ? "archived-item" : ""} ${cursorClass}" ${clickHandler}>`

          // Render columns based on entity type
          if (currentEntity === "competitions") {
            html += `
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${itemId}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4">${item.year}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${formatDate(item.starts)}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${item.format}</td>
                    `
          } else if (currentEntity === "teams") {
            html += `
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${itemId}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4">${item.letter || item.teamLetter}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4">${item.alias || item.teamName}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4">
                            <span class="inline-block w-5 h-5 md:w-6 md:h-6 rounded" style="background-color: ${item.color || item.teamColor}"></span>
                        </td>
                    `
          } else if (currentEntity === "players") {
            const playerTeam = teamsData.find((t) => (t.id || t._id) === item.team)
            html += `
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${itemId}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4">${item.firstName}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4">${item.lastName}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${playerTeam ? playerTeam.alias || playerTeam.teamName : "-"}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${item.primaryPosition}</td>
                    `
          } else if (currentEntity === "fixtures") {
            html += `
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${itemId}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${formatDate(item.starts)}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${item.venue || "Mo Arena"}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${item.referee || "-"}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${item.finalScore || "-"}</td>
                    `
          } else if (currentEntity === "events") {
            const participantNames = item.participants
              ? item.participants
                  .map((pId) => {
                    const player = playersData.find((p) => (p.id || p._id) === pId)
                    return player ? `${player.firstName} ${player.lastName}` : ""
                  })
                  .filter((n) => n)
                  .join(", ")
              : "-"

            html += `
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${itemId}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4">${item.title || item.eventTitle}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${item.notes || item.description || "-"}</td>
                        <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm">${participantNames}</td>
                    `
          }

          html += `
                    <td class="py-2 md:py-3 px-2 md:px-4" onclick="event.stopPropagation()">
                        <div class="flex space-x-2">
                            <button onclick="editItem('${itemId}')" class="text-primary hover:opacity-70">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            <button onclick="toggleArchive('${itemId}', ${isArchived})" class="text-warning hover:opacity-70">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    ${isArchived ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>'}
                                </svg>
                            </button>
                            <button onclick="deleteItem('${itemId}')" class="text-red-500 hover:opacity-70">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                `
          html += "</tr>"
        })

        html += "</tbody></table></div>"

        // Add detail panel if item is selected
        if (currentSelectedItem && config.hasDetails) {
          const selectedItem = entityData.find((item) => (item.id || item._id) === currentSelectedItem)
          if (selectedItem) {
            html += renderDetailPanel(selectedItem)
          }
        }

        listContent.innerHTML = html
      }

      // Detail Panel Rendering
      function renderDetailPanel(item) {
        let html = '<div class="detail-panel">'

        if (currentEntity === "competitions") {
          html += '<h3 class="text-base md:text-lg font-bold mb-4">Teams in Competition</h3>'
          const competitionTeams = item.teams || []

          if (competitionTeams.length === 0) {
            html += '<p class="text-secondary text-sm md:text-base">No teams assigned to this competition</p>'
          } else {
            html += '<div class="grid gap-2">'
            competitionTeams.forEach((teamId) => {
              const team = teamsData.find((t) => (t.id || t._id) === teamId)
              if (team) {
                html += `
                                <div class="detail-item">
                                    <span class="inline-block w-6 h-6 md:w-8 md:h-8 rounded mr-3" style="background-color: ${team.color || team.teamColor}"></span>
                                    <div>
                                        <div class="font-medium text-sm md:text-base">${team.alias || team.teamName}</div>
                                        <div class="text-xs md:text-sm text-secondary">Team ${team.letter || team.teamLetter}</div>
                                    </div>
                                </div>
                            `
              }
            })
            html += "</div>"
          }
        } else if (currentEntity === "teams") {
          html += '<h3 class="text-base md:text-lg font-bold mb-4">Players in Team</h3>'
          const teamPlayers = playersData.filter((p) => p.team === (item.id || item._id))

          if (teamPlayers.length === 0) {
            html += '<p class="text-secondary text-sm md:text-base">No players in this team</p>'
          } else {
            html += '<div class="grid gap-2">'
            teamPlayers.forEach((player) => {
              html += `
                            <div class="detail-item">
                                ${
                                  player.imageUrl || player.image
                                    ? `<img src="${player.imageUrl || player.image}" alt="${player.firstName}" class="player-image mr-3">`
                                    : `<div class="player-image mr-3 flex items-center justify-center bg-secondary text-primary">
                                        <span class="text-lg md:text-xl font-bold">${player.firstName[0]}${player.lastName[0]}</span>
                                    </div>`
                                }
                                <div>
                                    <div class="font-medium text-sm md:text-base">${player.firstName} ${player.lastName}</div>
                                    <div class="text-xs md:text-sm text-secondary">${player.primaryPosition} ${player.alias ? `â€¢ ${player.alias}` : ""}</div>
                                </div>
                            </div>
                        `
            })
            html += "</div>"
          }
        }

        html += "</div>"
        return html
      }

      // Show item details
      function showItemDetails(itemId) {
        if (currentSelectedItem === itemId) {
          currentSelectedItem = null
        } else {
          currentSelectedItem = itemId
        }
        renderList()
      }

      // Event Type Selection Handler
      function handleEventTypeChange(isMobile = false) {
        const prefix = isMobile ? "mobile-" : ""
        const selectElement = document.querySelector(`select[name="eventType"]`)
        const helperElement = document.getElementById(`${prefix}eventType-helper`)

        if (selectElement && helperElement) {
          const selectedValue = selectElement.value
          const eventType = eventTypes.find((e) => e.title === selectedValue)

          if (eventType) {
            helperElement.textContent = eventType.description
            helperElement.style.display = "block"
          } else {
            helperElement.textContent = ""
            helperElement.style.display = "none"
          }
        }
      }

      // Ordered Participants Management
      function addParticipant(isMobile = false) {
        const prefix = isMobile ? "mobile-" : ""
        const selectElement = document.querySelector(`select[name="participant-select"]`)

        if (!selectElement || !selectElement.value) {
          showToast("Please select a participant", "warning")
          return
        }

        const participantId = selectElement.value
        const participant = playersData.find((p) => (p.id || p._id) === participantId)

        if (!participant) {
          showToast("Participant not found", "error")
          return
        }

        // Check if participant already added
        if (orderedParticipants.includes(participantId)) {
          showToast("Participant already added", "warning")
          return
        }

        orderedParticipants.push(participantId)
        renderParticipantsList(isMobile)

        // Reset select
        selectElement.value = ""
      }

      function removeParticipant(index, isMobile = false) {
        orderedParticipants.splice(index, 1)
        renderParticipantsList(isMobile)
      }

      function renderParticipantsList(isMobile = false) {
        const prefix = isMobile ? "mobile-" : ""
        const listElement = document.getElementById(`${prefix}participants-list`)

        if (!listElement) return

        if (orderedParticipants.length === 0) {
          listElement.innerHTML = '<p class="text-secondary text-sm">No participants added yet</p>'
          return
        }

        let html = ""
        orderedParticipants.forEach((participantId, index) => {
          const player = playersData.find((p) => (p.id || p._id) === participantId)
          if (player) {
            html += `
                        <div class="participant-item">
                            <div class="flex items-center flex-1">
                                <span class="participant-number">${index + 1}</span>
                                <span class="text-sm md:text-base">${player.firstName} ${player.lastName}</span>
                            </div>
                            <button type="button" onclick="removeParticipant(${index}, ${isMobile})" class="text-red-500 hover:opacity-70 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    `
          }
        })

        listElement.innerHTML = html
      }

      // Form Rendering
      function renderForm(isMobile = false) {
        const formFields = isMobile ? document.getElementById("mobileFormFields") : document.getElementById("formFields")
        const config = entityConfigs[currentEntity]
        const prefix = isMobile ? "mobile-" : ""
        let html = ""

        config.fields.forEach((field) => {
          html += `<div class="mb-4">`
          html += `<label class="block text-sm font-medium text-secondary mb-2">${field.label}${field.required ? " *" : ""}</label>`

          if (field.type === "text" || field.type === "number" || field.type === "datetime-local" || field.type === "color") {
            html += `<input type="${field.type}" name="${field.name}" class="w-full px-3 md:px-4 py-2 rounded-md border border-custom text-sm md:text-base" ${field.required ? "required" : ""} ${field.default ? `value="${field.default}"` : ""} ${field.placeholder ? `placeholder="${field.placeholder}"` : ""}>`
          } else if (field.type === "file") {
            html += `
                        <div class="flex items-center space-x-4">
                            <label class="file-upload-label text-sm md:text-base">
                                Choose File
                                <input type="file" name="${field.name}" class="hidden" accept="${field.accept || ""}" onchange="handleFileSelect(event, '${field.name}', ${isMobile})">
                            </label>
                            <span id="${prefix}${field.name}-filename" class="text-xs md:text-sm text-secondary">No file selected</span>
                        </div>
                        <div id="${prefix}${field.name}-preview" class="mt-2"></div>
                    `
          } else if (field.type === "checkbox") {
            html += `<input type="checkbox" name="${field.name}" class="rounded">`
          } else if (field.type === "textarea") {
            html += `<textarea name="${field.name}" class="w-full px-3 md:px-4 py-2 rounded-md border border-custom text-sm md:text-base" rows="3" ${field.required ? "required" : ""}></textarea>`
          } else if (field.type === "select") {
            html += `<select name="${field.name}" class="w-full px-3 md:px-4 py-2 rounded-md border border-custom text-sm md:text-base" ${field.required ? "required" : ""}>`
            html += `<option value="">Select ${field.label}</option>`
            field.options.forEach((option) => {
              html += `<option value="${option}">${option}</option>`
            })
            html += `</select>`
          } else if (field.type === "select-events") {
            html += `<select name="${field.name}" class="w-full px-3 md:px-4 py-2 rounded-md border border-custom text-sm md:text-base" ${field.required ? "required" : ""} onchange="handleEventTypeChange(${isMobile})">`
            html += `<option value="">Select Event Type</option>`
            eventTypes.forEach((eventType) => {
              html += `<option value="${eventType.title}">${eventType.title}</option>`
            })
            html += `</select>`
            html += `<div id="${prefix}eventType-helper" class="event-description-helper" style="display: none;"></div>`
          } else if (field.type === "select-teams") {
            html += `<select name="${field.name}" class="w-full px-3 md:px-4 py-2 rounded-md border border-custom text-sm md:text-base" ${field.required ? "required" : ""}>`
            html += `<option value="">Select Team</option>`
            teamsData.forEach((team) => {
              html += `<option value="${team.id || team._id}">${team.alias || team.teamName}</option>`
            })
            html += `</select>`
          } else if (field.type === "select-competitions") {
            ;(html += `<select name="${field.name}" class="w-full px-3 md:px-4 py-2 rounded-md border border-custom text-sm md:text-base" ${field.required ? "required" : ""}>`),
              (html += `<option value="">Select Competition</option>`),
              competitionsData.forEach((competition) => {
                html += `<option value="${competition.id || competition._id}">${competition.year} - ${competition.format}</option>`
              }),
              (html += `</select>`)
          } else if (field.type === "select-fixtures") {
            html += `<select name="${field.name}" class="w-full px-3 md:px-4 py-2 rounded-md border border-custom text-sm md:text-base" ${field.required ? "required" : ""}>`
            html += `<option value="">Select Fixture</option>`

            fixturesData.forEach((fixture) => {
              const [homeId, awayId] = fixture.participants || []

              const homeTeam = teamsData.find((t) => (t.id || t._id) === homeId)
              const awayTeam = teamsData.find((t) => (t.id || t._id) === awayId)

              const homeName = homeTeam ? homeTeam.alias || homeTeam.teamName : "-"
              const awayName = awayTeam ? awayTeam.alias || awayTeam.teamName : "-"

              const kickoff = formatDate(fixture.starts)

              const label = `${homeName} - ${awayName} (${kickoff})`

              html += `<option value="${fixture.id || fixture._id}">${label}</option>`
            })

            html += `</select>`
          } else if (field.type === "ordered-select-players") {
            html += `
                        <div class="mb-2">
                            <select name="participant-select" class="w-full px-3 md:px-4 py-2 rounded-md border border-custom text-sm md:text-base">
                                <option value="">Select Player</option>
                                ${playersData
                                  .map((player) => {
                                    return `<option value="${player.id || player._id}">${player.firstName} ${player.lastName}</option>`
                                  })
                                  .join("")}
                            </select>
                        </div>
                        <button type="button" onclick="addParticipant(${isMobile})" class="mb-3 btn-primary py-2 px-4 rounded-md text-sm font-medium hover:opacity-90">
                            Add Participant
                        </button>
                        <div id="${prefix}participants-list" class="mt-2">
                            <p class="text-secondary text-sm">No participants added yet</p>
                        </div>
                    `
          } else if (field.type === "multi-select" || field.type === "multi-select-players" || field.type === "multi-select-teams" || field.type === "multi-select-events") {
            html += `<div class="relative">`
            html += `<div class="multi-select-container border border-custom rounded-md p-2 min-h-[42px] cursor-pointer" onclick="toggleMultiSelect('${prefix}${field.name}')">`
            html += `<div class="multi-select-tags text-sm md:text-base" id="${prefix}${field.name}-tags">Click to select</div>`
            html += `</div>`
            html += `<div class="hidden absolute z-10 w-full mt-1 bg-secondary border border-custom rounded-md shadow-lg multi-select-dropdown" id="${prefix}${field.name}-dropdown">`

            let options = []
            if (field.type === "multi-select-players") {
              options = playersData
            } else if (field.type === "multi-select-teams") {
              options = teamsData
            } else if (field.type === "multi-select-events") {
              options = eventsData
            } else {
              options = field.options
            }

            options.forEach((option, index) => {
              let value, label
              if (field.type === "multi-select-players") {
                value = option.id || option._id
                label = `${option.firstName} ${option.lastName}`
              } else if (field.type === "multi-select-teams") {
                value = option.id || option._id
                label = option.alias || option.teamName
              } else if (field.type === "multi-select-events") {
                value = option.id || option._id
                label = option.eventType || option.eventTitle
              } else {
                value = option
                label = option
              }

              html += `
                            <label class="block px-3 py-2 hover:bg-primary hover:bg-opacity-10 cursor-pointer text-sm md:text-base">
                                <input type="checkbox" name="${field.name}" value="${value}" class="mr-2" onchange="updateMultiSelect('${prefix}${field.name}', ${field.max || 999})">
                                ${label}
                            </label>
                        `
            })

            html += `</div></div>`
          }

          html += `</div>`
        })

        formFields.innerHTML = html
      }

      // File handling
      function handleFileSelect(event, fieldName, isMobile = false) {
        const file = event.target.files[0]
        const prefix = isMobile ? "mobile-" : ""
        const filenameSpan = document.getElementById(`${prefix}${fieldName}-filename`)
        const previewDiv = document.getElementById(`${prefix}${fieldName}-preview`)

        if (file) {
          filenameSpan.textContent = file.name

          // Show image preview
          if (file.type.startsWith("image/")) {
            const reader = new FileReader()
            reader.onload = (e) => {
              previewDiv.innerHTML = `<img src="${e.target.result}" class="image-preview">`
            }
            reader.readAsDataURL(file)
          }
        } else {
          filenameSpan.textContent = "No file selected"
          previewDiv.innerHTML = ""
        }
      }

      // Multi-select functionality
      function toggleMultiSelect(fieldName) {
        const dropdown = document.getElementById(`${fieldName}-dropdown`)
        dropdown.classList.toggle("hidden")
      }

      function updateMultiSelect(fieldName, maxSelections) {
        const checkboxes = document.querySelectorAll(`input[name="${fieldName.replace("mobile-", "")}"]:checked`)
        const tagsDiv = document.getElementById(`${fieldName}-tags`)

        if (checkboxes.length > maxSelections) {
          checkboxes[checkboxes.length - 1].checked = false
          showToast(`Maximum ${maxSelections} selections allowed`, "warning")
          return
        }

        if (checkboxes.length === 0) {
          tagsDiv.textContent = "Click to select"
        } else {
          const labels = Array.from(checkboxes).map((cb) => {
            const label = cb.parentElement.textContent.trim()
            return `<span class="inline-block bg-primary text-white px-2 py-1 rounded text-xs md:text-sm mr-1 mb-1">${label}</span>`
          })
          tagsDiv.innerHTML = labels.join("")
        }
      }

      // CRUD Operations
      async function saveEntity(data) {
        try {
          // Determine if this is FormData or regular object
          const isFormData = data instanceof FormData
          let requestBody
          let headers = {}

          if (isFormData && data.has("image") && data.get("image").size > 0) {
            // Send as multipart form data for file upload
            requestBody = data
            // Don't set Content-Type, let browser set it with boundary
          } else {
            // Convert to JSON
            if (isFormData) {
              // Convert FormData to object
              const jsonData = {}
              const config = entityConfigs[currentEntity]

              config.fields.forEach((field) => {
                if (field.type === "checkbox") {
                  jsonData[field.name] = data.has(field.name)
                } else if (field.type === "multi-select" || field.type === "multi-select-players" || field.type === "multi-select-teams" || field.type === "multi-select-events") {
                  jsonData[field.name] = data.getAll(field.name)
                } else if (field.type === "ordered-select-players") {
                  console.log("Assigning ordered participants:", orderedParticipants)
                  jsonData[field.name] = orderedParticipants || []
                } else if (field.type === "number") {
                  const value = data.get(field.name)
                  jsonData[field.name] = value ? parseInt(value) : null
                } else if (field.type !== "file") {
                  jsonData[field.name] = data.get(field.name) || null
                }
              })
              requestBody = JSON.stringify(jsonData)
            } else {
              requestBody = JSON.stringify(data)
            }
            headers["Content-Type"] = "application/json"
          }

          if (authToken) {
            headers["Authorization"] = `Bearer ${authToken}`
          }

          const url = currentEditId ? `${API_BASE_URL}/${currentEntity}/${currentEditId}` : `${API_BASE_URL}/${currentEntity}`

          const response = await fetch(url, {
            method: currentEditId ? "PUT" : "POST",
            headers,
            body: requestBody,
          })

          if (!response.ok) {
            throw new Error(`Request failed: ${response.status}`)
          }

          showToast(currentEditId ? "Item updated successfully" : "Item created successfully")
          currentEditId = null
          orderedParticipants = []
          await loadEntity(currentEntity)
          await loadAllRelatedData() // Refresh all data
          document.getElementById("entityForm").reset()
          document.getElementById("mobileEntityForm").reset()
          hideMobileForm()

          // Clear file preview
          document.querySelectorAll('[id$="-filename"]').forEach((el) => {
            el.textContent = "No file selected"
          })
          document.querySelectorAll('[id$="-preview"]').forEach((el) => {
            el.innerHTML = ""
          })
        } catch (error) {
          console.error("Save error:", error)
          showToast("Failed to save item", "error")
        }
      }

      async function editItem(id) {
        event.stopPropagation()
        currentEditId = id
        orderedParticipants = []
        const item = entityData.find((e) => (e.id || e._id) === id)
        if (!item) return

        const form = document.getElementById("entityForm")
        const mobileForm = document.getElementById("mobileEntityForm")
        const config = entityConfigs[currentEntity]

        // Populate both forms
        ;[form, mobileForm].forEach((currentForm) => {
          if (!currentForm) return

          const isMobile = currentForm === mobileForm

          config.fields.forEach((field) => {
            const element = currentForm.elements[field.name]
            if (!element && field.type !== "file" && field.type !== "ordered-select-players") return

            if (field.type === "checkbox") {
              element.checked = item[field.name] || false
            } else if (field.type === "ordered-select-players") {
              // Load participants in order - handle both string and array formats
              orderedParticipants = Array.isArray(item.participants) ? item.participants : item.participants ? [item.participants] : []
              renderParticipantsList(isMobile)
            } else if (field.type === "multi-select" || field.type === "multi-select-players" || field.type === "multi-select-teams" || field.type === "multi-select-events") {
              const values = item[field.name] || []
              const checkboxes = currentForm.querySelectorAll(`input[name="${field.name}"]`)
              checkboxes.forEach((cb) => {
                cb.checked = values.includes(cb.value)
              })
              const prefix = isMobile ? "mobile-" : ""
              updateMultiSelect(`${prefix}${field.name}`, field.max || 999)
            } else if (field.type === "select-events") {
              element.value = item.eventType || item.eventTitle || ""
              handleEventTypeChange(isMobile)
            } else if (field.type === "datetime-local" && item[field.name]) {
              element.value = item[field.name].slice(0, 16)
            } else if (field.type === "file") {
              // Show existing image if available
              const prefix = isMobile ? "mobile-" : ""
              if (item[field.name] || item.image || item.imageUrl) {
                const previewDiv = document.getElementById(`${prefix}${field.name}-preview`)
                const imageUrl = item[field.name] || item.image || item.imageUrl
                if (previewDiv) {
                  previewDiv.innerHTML = `<img src="${imageUrl}" class="image-preview">`
                }
              }
            } else {
              element.value = item[field.name] || ""
            }
          })
        })

        // Show mobile form on mobile devices
        if (window.innerWidth < 768) {
          showMobileForm()
        } else {
          document.querySelector("#formFields").scrollIntoView({ behavior: "smooth" })
        }
      }

      async function toggleArchive(id, isArchived) {
        event.stopPropagation()
        try {
          await makeRequest(`/${currentEntity}/${id}/archive`, {
            method: "PATCH",
            body: JSON.stringify({ archived: !isArchived }),
          })
          showToast(isArchived ? "Item restored" : "Item archived")
          await loadEntity(currentEntity)
        } catch (error) {
          showToast("Failed to update item", "error")
        }
      }

      async function deleteItem(id) {
        event.stopPropagation()
        const confirmed = await showConfirmDialog("Are you sure you want to delete this item? This action cannot be undone.")
        if (!confirmed) return

        try {
          await makeRequest(`/${currentEntity}/${id}`, {
            method: "DELETE",
          })
          showToast("Item deleted successfully")
          await loadEntity(currentEntity)
          await loadAllRelatedData() // Refresh all data
        } catch (error) {
          showToast("Failed to delete item", "error")
        }
      }

      // Utility Functions
      function formatDate(dateString) {
        if (!dateString) return "-"
        const date = new Date(dateString)
        const dateStr = date.toLocaleDateString()
        const timeStr = date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
        return `${dateStr} ${timeStr}`
      }

      // Event Listeners
      document.addEventListener("DOMContentLoaded", () => {
        initTheme()
        checkAuth()

        // Login form
        document.getElementById("loginForm").addEventListener("submit", async (e) => {
          e.preventDefault()
          const username = document.getElementById("loginUsername").value
          const password = document.getElementById("loginPassword").value
          await login(username, password)
        })

        // Theme toggle
        document.getElementById("themeToggle").addEventListener("click", toggleTheme)

        // Logout
        document.getElementById("logoutBtn").addEventListener("click", logout)
        document.getElementById("logoutBtnMobile").addEventListener("click", logout)

        // Refresh
        document.getElementById("refreshBtn").addEventListener("click", () => {
          loadEntity(currentEntity)
          showToast("Data refreshed")
        })

        // Show archived toggle
        document.getElementById("showArchived").addEventListener("change", () => {
          loadEntity(currentEntity)
        })

        document.getElementById("showArchivedMobile").addEventListener("change", (e) => {
          document.getElementById("showArchived").checked = e.target.checked
          loadEntity(currentEntity)
        })

        // Search
        document.getElementById("searchInput").addEventListener("input", renderList)

        // Sidebar navigation (desktop)
        document.querySelectorAll(".sidebar-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            e.preventDefault()
            const entity = item.dataset.entity
            if (entity) {
              loadEntity(entity)
            }
          })
        })

        // Bottom nav navigation (mobile)
        document.querySelectorAll(".bottom-nav-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            e.preventDefault()
            const entity = item.dataset.entity
            if (entity) {
              loadEntity(entity)
            }
          })
        })

        // Mobile menu
        document.getElementById("mobileMenuBtn").addEventListener("click", showMobileMenu)
        document.getElementById("closeMobileMenu").addEventListener("click", hideMobileMenu)
        document.getElementById("mobileMenuOverlay").addEventListener("click", (e) => {
          if (e.target === e.currentTarget) {
            hideMobileMenu()
          }
        })

        // Mobile form
        document.getElementById("addNewBtn").addEventListener("click", () => {
          renderForm(true)
          showMobileForm()
        })
        document.getElementById("closeMobileForm").addEventListener("click", hideMobileForm)
        document.getElementById("mobileFormOverlay").addEventListener("click", (e) => {
          if (e.target === e.currentTarget) {
            hideMobileForm()
          }
        })

        // Entity forms
        document.getElementById("entityForm").addEventListener("submit", async (e) => {
          e.preventDefault()
          const formData = new FormData(e.target)

          // Check if this is a file upload scenario
          const hasFileUpload = currentEntity === "players" && formData.has("image") && formData.get("image").size > 0

          if (hasFileUpload) {
            await saveEntity(formData)
          } else {
            const data = {}
            const config = entityConfigs[currentEntity]

            config.fields.forEach((field) => {
              if (field.type === "checkbox") {
                data[field.name] = formData.has(field.name)
              } else if (field.type === "multi-select" || field.type === "multi-select-players" || field.type === "multi-select-teams" || field.type === "multi-select-events") {
                data[field.name] = formData.getAll(field.name)
              } else if (field.type === "ordered-select-players") {
                data[field.name] = orderedParticipants || []
              } else if (field.type === "number") {
                const value = formData.get(field.name)
                data[field.name] = value ? parseInt(value) : null
              } else if (field.type !== "file") {
                data[field.name] = formData.get(field.name) || null
              }
            })

            await saveEntity(data)
          }
        })

        document.getElementById("mobileEntityForm").addEventListener("submit", async (e) => {
          e.preventDefault()
          const formData = new FormData(e.target)

          // Check if this is a file upload scenario
          const hasFileUpload = currentEntity === "players" && formData.has("image") && formData.get("image").size > 0

          if (hasFileUpload) {
            await saveEntity(formData)
          } else {
            const data = {}
            const config = entityConfigs[currentEntity]

            config.fields.forEach((field) => {
              if (field.type === "checkbox") {
                data[field.name] = formData.has(field.name)
              } else if (field.type === "multi-select" || field.type === "multi-select-players" || field.type === "multi-select-teams" || field.type === "multi-select-events") {
                data[field.name] = formData.getAll(field.name)
              } else if (field.type === "ordered-select-players") {
                data[field.name] = orderedParticipants || []
              } else if (field.type === "number") {
                const value = formData.get(field.name)
                data[field.name] = value ? parseInt(value) : null
              } else if (field.type !== "file") {
                data[field.name] = formData.get(field.name) || null
              }
            })

            await saveEntity(data)
          }
        })

        // Click outside to close multi-select dropdowns
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".multi-select-container") && !e.target.closest(".multi-select-dropdown")) {
            document.querySelectorAll(".multi-select-dropdown").forEach((dropdown) => {
              dropdown.classList.add("hidden")
            })
          }
        })
      })
    </script>
  </body>
</html>
